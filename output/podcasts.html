<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morning Brief</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #F7F7F5;
  --surface: #FFFFFF;
  --text: #111111;
  --text-mid: #555555;
  --text-light: #999999;
  --border: #E5E5E5;
  --hover: #F0EFED;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #1A1917;
    --surface: #242320;
    --text: #E5E4E0;
    --text-mid: #A8A6A0;
    --text-light: #6B6963;
    --border: #333230;
    --hover: #2C2B28;
  }
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  line-height: 1.6;
}

/* === ROW 1: HEADER — title + date pills === */
.header {
  max-width: 1000px;
  margin: 0 auto;
  padding: 40px 32px 0;
  display: flex;
  align-items: baseline;
  gap: 16px;
  flex-wrap: wrap;
}
.back-link {
  font-size: 20px;
  font-weight: 400;
  color: var(--text-mid);
  text-decoration: none;
  flex-shrink: 0;
  transition: color 0.12s ease;
  line-height: 1;
}
.back-link:hover { color: var(--text); }
.header h1 {
  font-size: 22px;
  font-weight: 600;
  letter-spacing: -0.3px;
  flex-shrink: 0;
}
.header h1 span {
  font-weight: 300;
  color: var(--text-light);
  margin-left: 4px;
}
.date-pills {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
}

/* === DATE NAV === */
.date-nav {
  display: none;
}

/* === ROW 2: TOOLBAR — category filters + expand all === */
.toolbar {
  max-width: 1000px;
  margin: 0 auto;
  padding: 14px 32px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}
.toolbar-left {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.toolbar-sep {
  display: none;
}
.date-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  padding: 4px 9px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.15s ease;
  white-space: nowrap;
}
.date-btn:hover { background: var(--hover); border-color: var(--text-light); }
.date-btn.active { background: var(--text); border-color: var(--text); color: var(--bg); }
.filters {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.filter-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  padding: 5px 14px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.15s ease;
  text-transform: lowercase;
}
.filter-btn:hover { background: var(--hover); border-color: var(--text-light); }
.filter-btn.active { background: var(--text); border-color: var(--text); color: var(--bg); }

.expand-all-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  padding: 5px 14px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-light);
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}
.expand-all-btn:hover { background: var(--hover); border-color: var(--text-light); color: var(--text-mid); }
.expand-all-btn .arrow { display: inline-block; transition: transform 0.2s; font-size: 13px; }
.expand-all-btn.expanded .arrow { transform: rotate(90deg); }

.divider {
  max-width: 1000px;
  margin: 16px auto 0;
  padding: 0 32px;
}
.divider hr { border: none; height: 1px; background: var(--border); }

/* === SUMMARY COUNT === */
.summary-count {
  max-width: 1000px;
  margin: 0 auto;
  padding: 12px 32px 0;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-light);
}

/* === CARDS === */
.grid {
  max-width: 1000px;
  margin: 0 auto;
  padding: 4px 32px 80px;
}
.card {
  display: grid;
  grid-template-columns: 4px 1fr;
  gap: 0;
  padding: 28px 0;
  border-bottom: 1px solid var(--border);
}
.card-accent {
  border-radius: 2px;
  margin-top: 4px;
  height: 20px;
}
.card-content { padding-left: 20px; }
.card-top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}
.card-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  padding: 2px 8px;
  border-radius: 3px;
  background: var(--hover);
}
.card-source {
  font-size: 13px;
  color: var(--text-light);
}
.card-duration {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-light);
}
.card-title {
  font-size: 19px;
  font-weight: 600;
  line-height: 1.35;
  margin-bottom: 8px;
  letter-spacing: -0.2px;
}
.card-hook {
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-mid);
}
.card-expand {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-light);
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 12px;
  transition: color 0.15s;
}
.card-expand:hover { color: var(--text); }
.card-expand .arrow {
  display: inline-block;
  transition: transform 0.2s;
  font-size: 14px;
}
.card.open .card-expand .arrow { transform: rotate(90deg); }
.card.open .card-expand .label-text { }

/* === EXPANDED SUMMARY === */
.card-body {
  display: none;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}
.card.open .card-body { display: block; }
.section-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-light);
  margin-bottom: 10px;
}
.finding {
  display: grid;
  grid-template-columns: 20px 1fr;
  gap: 0;
  margin-bottom: 10px;
  font-size: 14px;
  line-height: 1.6;
  color: var(--text);
}
.finding-num {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-light);
  padding-top: 3px;
}
.so-what-section { margin-top: 20px; }
.so-what-text {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text-mid);
}

/* === FALLBACK SUMMARY STYLES === */
.summary-fallback h1,
.summary-fallback h2,
.summary-fallback h3 { margin: 0.75rem 0 0.25rem; font-size: 1rem; font-weight: 600; }
.summary-fallback p { margin-bottom: 0.5rem; font-size: 14px; line-height: 1.6; color: var(--text); }
.summary-fallback ul, .summary-fallback ol { margin: 0.5rem 0 0.5rem 1.5rem; font-size: 14px; }
.summary-fallback strong { font-weight: 600; }

.card-actions {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
}
.action-link {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-light);
  text-decoration: none;
  transition: color 0.15s;
}
.action-link:hover { color: var(--text); }
.listen-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-light);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 4px 10px;
  background: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.15s;
}
.listen-btn:hover { background: var(--hover); color: var(--text); }
.listen-btn.playing { background: #e74c3c; color: #fff; border-color: #e74c3c; }

/* === TTS SPEED === */
.tts-controls {
  display: none;
  gap: 6px;
  align-items: center;
  margin-top: 10px;
}
.tts-controls.visible { display: flex; }
.tts-speed-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text-light);
  letter-spacing: 0.5px;
  margin-right: 2px;
}
.speed-btn {
  font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-mid);
  border-radius: 4px;
  cursor: pointer;
  font-size: 10px;
  transition: all 0.15s;
}
.speed-btn:hover { background: var(--hover); }
.speed-btn.active { background: var(--text); color: var(--bg); border-color: var(--text); }

/* === STATES === */
.empty {
  text-align: center;
  color: var(--text-light);
  padding: 3rem;
  font-size: 14px;
}
.error-text {
  font-family: 'JetBrains Mono', monospace;
  color: #e74c3c;
  font-size: 12px;
  font-style: italic;
}
#loading {
  text-align: center;
  padding: 3rem;
  color: var(--text-light);
  font-size: 14px;
}

/* === RESPONSIVE === */
@media (max-width: 640px) {
  .header { padding: 28px 16px 0; flex-direction: column; gap: 4px; }
  .toolbar { padding: 16px; }
  .toolbar-left { gap: 4px; }
  .toolbar-sep { display: none; }
  .divider { padding: 0 16px; }
  .summary-count { padding: 10px 16px 0; }
  .grid { padding: 0 16px 60px; }
  .card-title { font-size: 17px; }
  .card-duration { display: none; }
}
</style>
</head>
<body>
<header class="header">
  <a class="back-link" href="index.html" title="Back to Morning Brief">←</a>
  <h1>Morning Brief<span>/ podcasts</span></h1>
  <div class="date-pills" id="dateButtons"></div>
</header>

<nav class="date-nav" id="dateNav"></nav>

<div class="toolbar">
  <div class="toolbar-left">
    <div class="filters" id="filters"></div>
  </div>
  <button class="expand-all-btn" id="expandAllBtn" onclick="toggleExpandAll()">
    <span class="arrow">&rarr;</span> <span class="label-text">expand all</span>
  </button>
</div>

<div class="divider"><hr></div>
<div class="summary-count"><span id="visibleCount">0</span> summaries</div>

<div class="grid" id="content">
  <div id="loading">loading...</div>
</div>

<script>
/* ===== STATE ===== */
var CATEGORIES = {};
var DIGEST_INDEX = [];
var currentDate = '';
var currentFilter = 'all';
var allExpanded = false;
var currentUtterance = null;
var currentSpeed = 1.0;

/* ===== MARKDOWN PARSER ===== */
function md2html(md) {
  if (!md) return '';
  var html = md
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
  html = html.split('\n').map(function(line) {
    line = line.trim();
    if (!line) return '';
    if (line.startsWith('<h') || line.startsWith('<ul') || line.startsWith('<li') ||
        line.startsWith('<blockquote') || line.startsWith('---')) return line;
    return '<p>' + line + '</p>';
  }).join('\n');
  return html;
}

/* ===== TTS ===== */
function stopTTS() {
  window.speechSynthesis.cancel();
  currentUtterance = null;
  document.querySelectorAll('.listen-btn.playing').forEach(function(b) {
    b.classList.remove('playing');
    b.innerHTML = '\u25B6 listen';
  });
}

function speakText(text, btn, lang) {
  stopTTS();
  var utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = currentSpeed;
  if (lang) utterance.lang = lang;
  utterance.onend = function() {
    btn.classList.remove('playing');
    btn.innerHTML = '\u25B6 listen';
    currentUtterance = null;
  };
  currentUtterance = utterance;
  btn.classList.add('playing');
  btn.innerHTML = '\u25A0 stop';
  window.speechSynthesis.speak(utterance);
}

function setSpeed(speed, cardId) {
  currentSpeed = speed;
  /* Highlight the active speed button in the relevant card (or all cards) */
  var scope = cardId ? document.getElementById('tts-' + cardId) : document;
  if (!scope) scope = document;
  scope.querySelectorAll('.speed-btn').forEach(function(b) {
    b.classList.toggle('active', parseFloat(b.dataset.speed) === speed);
  });
  /* If currently speaking, restart with new speed */
  if (currentUtterance) {
    var text = currentUtterance.text;
    var lang = currentUtterance.lang;
    var playingBtn = document.querySelector('.listen-btn.playing');
    if (playingBtn) speakText(text, playingBtn, lang);
  }
}

/* ===== INIT ===== */
async function init() {
  try {
    var catResp = await fetch('categories.json');
    CATEGORIES = catResp.ok ? await catResp.json() : {};
  } catch(e) { CATEGORIES = {}; }

  try {
    var idxResp = await fetch('podcast-index.json');
    DIGEST_INDEX = idxResp.ok ? await idxResp.json() : [];
  } catch(e) { DIGEST_INDEX = []; }

  DIGEST_INDEX = DIGEST_INDEX.sort().reverse();

  if (DIGEST_INDEX.length === 0) {
    document.getElementById('content').innerHTML =
      '<div class="empty">No podcast episodes available yet. Run the pipeline first.</div>';
    return;
  }

  var nav = document.getElementById('dateButtons');
  DIGEST_INDEX.forEach(function(d, i) {
    var btn = document.createElement('button');
    btn.className = 'date-btn' + (i === 0 ? ' active' : '');
    btn.dataset.date = d;
    // Display MM/DD — compact enough to fit 7 buttons in a row
    var parts = d.split('-');
    btn.textContent = parts[1] + '/' + parts[2];
    btn.title = d;  // full date on hover
    btn.onclick = function() { loadDate(d); };
    nav.appendChild(btn);
  });

  buildFilters();
  loadDate(DIGEST_INDEX[0]);
}

function buildFilters() {
  var container = document.getElementById('filters');
  container.innerHTML = '';

  var allBtn = document.createElement('button');
  allBtn.className = 'filter-btn active';
  allBtn.dataset.cat = 'all';
  allBtn.textContent = 'all';
  allBtn.onclick = function() { applyFilter('all'); };
  container.appendChild(allBtn);

  Object.keys(CATEGORIES).forEach(function(name) {
    var btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.dataset.cat = name;
    btn.textContent = name.toLowerCase();
    btn.onclick = function() { applyFilter(name); };
    container.appendChild(btn);
  });
}

/* ===== DATE LOADING ===== */
async function loadDate(dateStr) {
  currentDate = dateStr;
  allExpanded = false;
  updateExpandBtn();
  stopTTS();

  document.querySelectorAll('.date-btn').forEach(function(b) {
    b.classList.toggle('active', b.dataset.date === dateStr);
  });

  var content = document.getElementById('content');
  content.innerHTML = '<div id="loading">loading...</div>';

  try {
    var resp = await fetch('podcast-daily/' + dateStr + '.md');
    if (!resp.ok) throw new Error('Not found');
    var md = await resp.text();
    renderDigest(md, dateStr);
  } catch(e) {
    content.innerHTML = '<div class="empty">No digest for ' + dateStr + '</div>';
  }
}

/* ===== DIGEST RENDERER ===== */
function renderDigest(md, dateStr) {
  var content = document.getElementById('content');
  var lines = md.split('\n');
  var html = '';
  var currentCategory = null;
  var currentCard = null;
  var cardCount = 0;

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];

    if (line.startsWith('## ')) {
      if (currentCard) { html += closeCard(currentCard, cardCount); currentCard = null; }
      currentCategory = line.substring(3).trim();

    } else if (line.startsWith('### ')) {
      if (currentCard) { html += closeCard(currentCard, cardCount); }
      cardCount++;
      var title = line.substring(4).trim();
      var color = currentCategory ? (CATEGORIES[currentCategory] || '#888') : '#888';
      currentCard = { title: title, id: cardCount, category: currentCategory, color: color, channel: '', duration: '', language: 'en', summaryPath: '' };
      html += '<div class="card" id="card-' + cardCount + '" data-cat="' + (currentCategory || '') + '">';
      html += '<div class="card-accent" style="background:' + color + '"></div>';
      html += '<div class="card-content">';
      html += '<div class="card-top">';
      html += '<span class="card-tag" style="color:' + color + '">' + (currentCategory || '').toUpperCase() + '</span>';

    } else if (currentCard && line.startsWith('**') && line.includes('|')) {
      var parts = line.replace(/\*\*/g, '').split('|').map(function(s) { return s.trim(); });
      var channel = parts[0] || '';
      var duration = parts[1] || '';
      var pubDate = parts[2] || '';
      currentCard.channel = channel;
      currentCard.duration = duration;

      var metaParts = [channel];
      if (duration) metaParts.push(duration);
      if (pubDate && pubDate.length === 10 && pubDate[4] === '-') {
        var pd = new Date(pubDate + 'T00:00:00');
        var formatted = pd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        metaParts.push(formatted);
      }
      html += '<span class="card-source">' + metaParts.join(' · ') + '</span>';
      html += '</div>';
      html += '<h3 class="card-title">' + currentCard.title + '</h3>';

    } else if (currentCard && line.includes('[Summary]')) {
      // Extract the path from [Summary](path) and store on the card
      var summaryMatch = line.match(/\[Summary\]\(([^)]+)\)/);
      if (summaryMatch) currentCard.summaryPath = summaryMatch[1];
      html += '<button class="card-expand" onclick="toggleSummary(' + cardCount + ')">';
      html += '<span class="arrow">\u2192</span> <span class="label-text">read summary</span></button>';

    } else if (currentCard && line.includes('Error:')) {
      html += '<span class="error-text">' + line.replace('>', '').trim() + '</span>';
    }
  }
  if (currentCard) html += closeCard(currentCard, cardCount);

  if (cardCount === 0) {
    content.innerHTML = '<div class="empty">No new content for ' + dateStr + '.</div>';
  } else {
    content.innerHTML = html;
    applyFilter(currentFilter);
  }
}

function closeCard(card, id) {
  var h = '';
  h += '<div class="card-body" id="body-' + id + '"';
  h += ' data-title="' + card.title.replace(/"/g, '&quot;') + '"';
  h += ' data-channel="' + card.channel.replace(/"/g, '&quot;') + '"';
  h += ' data-duration="' + card.duration.replace(/"/g, '&quot;') + '"';
  h += ' data-language="' + (card.language || 'en') + '"';
  if (card.summaryPath) h += ' data-summary-path="' + card.summaryPath + '"';
  h += '></div>';
  h += '</div>';
  h += '</div>';
  return h;
}

/* ===== EXPAND / COLLAPSE ===== */
async function toggleSummary(id) {
  var card = document.getElementById('card-' + id);
  var body = document.getElementById('body-' + id);
  var expandBtn = card.querySelector('.card-expand');

  if (card.classList.contains('open')) {
    card.classList.remove('open');
    if (expandBtn) expandBtn.querySelector('.label-text').textContent = 'read summary';
    stopTTS();
    return;
  }

  if (!body.dataset.loaded) {
    // Prefer the path embedded in the digest markdown; fall back to slug reconstruction
    var summaryPath = body.dataset.summaryPath ||
      ('podcast-summaries/' + currentDate + '/' + findSlugForCard(id) + '.md');
    try {
      var resp = await fetch(summaryPath);
      if (!resp.ok) throw new Error('Not found');
      var md = await resp.text();
      body.innerHTML = parseSummaryMd(md, id);
      body.dataset.loaded = 'true';

      /* Build TTS text: title + channel, then Key Findings + So What only */
      var title = body.dataset.title || '';
      var channel = body.dataset.channel || '';
      var tsParts = md.split('---');
      var summaryMd = tsParts.length > 2 ? tsParts.slice(2).join('---') : md;
      var ttsIntro = title;
      if (channel) ttsIntro += ', by ' + channel;
      ttsIntro += '. ';
      /* Extract only Key Findings and So What sections for TTS */
      var ttsBody = extractTTSBody(summaryMd);
      /* Strip markdown syntax and URLs from TTS text */
      var plainBody = ttsBody
        .replace(/https?:\/\/[^\s)]+/g, '')
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/[#*\[\]()>]/g, '')
        .replace(/\n+/g, ' ')
        .replace(/\s{2,}/g, ' ')
        .trim();
      body.dataset.plainText = ttsIntro + plainBody;
    } catch(e) {
      body.innerHTML = '<span class="error-text">Could not load summary.</span>';
    }
  }

  card.classList.add('open');
  if (expandBtn) expandBtn.querySelector('.label-text').textContent = 'collapse';
}

function extractTTSBody(summaryMd) {
  /* Extract only Key Findings and So What sections, skip Hook/metadata */
  var lines = summaryMd.split('\n');
  var result = '';
  var currentSection = '';
  for (var i = 0; i < lines.length; i++) {
    var trimmed = lines[i].trim();
    if (trimmed === '## The Hook') { currentSection = 'hook'; continue; }
    if (trimmed === '## Key Findings') { currentSection = 'findings'; result += 'Key findings. '; continue; }
    if (trimmed === '## The So What?' || trimmed === '## The So What') { currentSection = 'sowhat'; result += 'So what. '; continue; }
    if ((currentSection === 'findings' || currentSection === 'sowhat') && trimmed) {
      result += trimmed + ' ';
    }
  }
  return result || summaryMd;
}

function parseSummaryMd(md, cardId) {
  var parts = md.split('---');
  var summaryMd = parts.length > 2 ? parts.slice(2).join('---') : md;

  var hookText = '';
  var findings = [];
  var soWhatText = '';
  var currentSection = '';

  var lines = summaryMd.split('\n');
  for (var i = 0; i < lines.length; i++) {
    var trimmed = lines[i].trim();
    if (trimmed === '## The Hook') { currentSection = 'hook'; continue; }
    if (trimmed === '## Key Findings') { currentSection = 'findings'; continue; }
    if (trimmed === '## The So What?' || trimmed === '## The So What') { currentSection = 'sowhat'; continue; }

    if (currentSection === 'hook' && trimmed) hookText += trimmed + ' ';
    if (currentSection === 'findings' && trimmed.startsWith('*')) {
      findings.push(trimmed.replace(/^\*\s*/, '').replace(/^\*\*(.+?):\*\*/, '<strong>$1:</strong>'));
    }
    if (currentSection === 'sowhat' && trimmed) soWhatText += trimmed + ' ';
  }

  /* Fall back to raw markdown if structure not detected */
  if (!hookText && !findings.length && !soWhatText) {
    return '<div class="summary-fallback">' + md2html(summaryMd) + '</div>';
  }

  var html = '';

  /* Inject hook text into the card as a preview */
  var cardEl = document.getElementById('card-' + cardId);
  if (cardEl && hookText) {
    var hookEl = cardEl.querySelector('.card-hook');
    if (!hookEl) {
      var titleEl = cardEl.querySelector('.card-title');
      if (titleEl) {
        hookEl = document.createElement('p');
        hookEl.className = 'card-hook';
        titleEl.after(hookEl);
      }
    }
    if (hookEl) hookEl.textContent = hookText.trim();
  }

  /* Key Findings with numbered rows */
  if (findings.length) {
    html += '<div class="section-label">Key Findings</div>';
    for (var j = 0; j < findings.length; j++) {
      var num = String(j + 1).padStart(2, '0');
      html += '<div class="finding"><span class="finding-num">' + num + '</span><span>' + findings[j] + '</span></div>';
    }
  }

  /* So What */
  if (soWhatText) {
    html += '<div class="so-what-section"><div class="section-label">So What</div>';
    html += '<p class="so-what-text">' + soWhatText.trim() + '</p></div>';
  }

  /* Extract watch URL from metadata */
  var watchUrl = '';
  var sourceMatch = md.match(/\*\*Source:\*\*\s*\[([^\]]+)\]\(([^)]+)\)/);
  if (sourceMatch) watchUrl = sourceMatch[2];

  /* Extract language from metadata */
  var langMatch = md.match(/\*\*Language:\*\*\s*(\S+)/);
  var summaryLang = langMatch ? langMatch[1] : 'en';
  /* Store language on the card body for TTS */
  var bodyEl = document.getElementById('body-' + cardId);
  if (bodyEl) bodyEl.dataset.language = summaryLang;

  /* Actions: source link + listen button */
  html += '<div class="card-actions">';
  if (watchUrl) html += '<a href="' + watchUrl + '" target="_blank" class="action-link">source \u2197</a>';
  html += '<button class="listen-btn" onclick="toggleTTS(' + cardId + ')">\u25B6 listen</button>';
  html += '</div>';

  /* TTS speed controls: 4 speeds */
  html += '<div class="tts-controls" id="tts-' + cardId + '">';
  html += '<span class="tts-speed-label">speed</span>';
  [1.0, 1.2, 1.5, 2.0].forEach(function(s) {
    var isActive = s === currentSpeed ? ' active' : '';
    html += '<button class="speed-btn' + isActive + '" data-speed="' + s + '" onclick="setSpeed(' + s + ',' + cardId + ')">' + s + 'x</button>';
  });
  html += '</div>';

  return html;
}

function toggleTTS(id) {
  var body = document.getElementById('body-' + id);
  var btn = body ? body.querySelector('.listen-btn') : null;
  var ttsControls = document.getElementById('tts-' + id);
  if (!body || !body.dataset.plainText || !btn) return;

  if (currentUtterance && btn.classList.contains('playing')) {
    stopTTS();
    if (ttsControls) ttsControls.classList.remove('visible');
  } else {
    var lang = body.dataset.language || 'en';
    speakText(body.dataset.plainText, btn, lang);
    if (ttsControls) ttsControls.classList.add('visible');
  }
}

/* ===== FILTER ===== */
function applyFilter(cat) {
  currentFilter = cat;
  document.querySelectorAll('.filter-btn').forEach(function(b) {
    b.classList.toggle('active', b.dataset.cat === cat);
  });
  var count = 0;
  document.querySelectorAll('.card').forEach(function(c) {
    var show = cat === 'all' || c.dataset.cat === cat;
    c.style.display = show ? '' : 'none';
    if (show) count++;
  });
  var countEl = document.getElementById('visibleCount');
  if (countEl) countEl.textContent = count;
}

/* ===== EXPAND ALL / COLLAPSE ALL ===== */
async function toggleExpandAll() {
  allExpanded = !allExpanded;
  updateExpandBtn();

  var cards = document.querySelectorAll('.card');
  for (var i = 0; i < cards.length; i++) {
    var card = cards[i];
    if (card.style.display === 'none') continue;
    var id = parseInt(card.id.replace('card-', ''));
    if (allExpanded && !card.classList.contains('open')) {
      await toggleSummary(id);
    } else if (!allExpanded && card.classList.contains('open')) {
      card.classList.remove('open');
      var expandBtn = card.querySelector('.card-expand');
      if (expandBtn) expandBtn.querySelector('.label-text').textContent = 'read summary';
    }
  }
  if (!allExpanded) stopTTS();
}

function updateExpandBtn() {
  var btn = document.getElementById('expandAllBtn');
  if (!btn) return;
  btn.classList.toggle('expanded', allExpanded);
  btn.querySelector('.label-text').textContent = allExpanded ? 'collapse all' : 'expand all';
}

/* ===== SLUG ===== */
function findSlugForCard(id) {
  var card = document.getElementById('card-' + id);
  var title = card.querySelector('.card-title').textContent;
  return title.toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/[\s_]+/g, '-')
    .replace(/-+/g, '-')
    .substring(0, 80)
    .replace(/^-|-$/g, '');
}

/* ===== BOOT ===== */
init();
document.addEventListener('DOMContentLoaded', function() { setSpeed(1.0, null); });
</script>
</body>
</html>