<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morning Brief</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #F7F7F5; --surface: #FFFFFF; --text: #111111; --text-mid: #555555;
  --text-light: #999999; --border: #E5E5E5; --hover: #F0EFED;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #1A1917; --surface: #242320; --text: #E5E4E0;
    --text-mid: #A8A6A0; --text-light: #6B6963; --border: #333230; --hover: #2C2B28;
  }
}
body { font-family: 'DM Sans', -apple-system, sans-serif; font-size: 15px;
       background: var(--bg); color: var(--text); line-height: 1.6; }
.header { max-width: 1000px; margin: 0 auto; padding: 40px 32px 28px; }
.header-date {
  font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 500;
  letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-mid); margin-bottom: 4px;
}
.header-app { font-size: 28px; font-weight: 300; letter-spacing: -0.5px; line-height: 1; }
.header-app strong { font-weight: 600; }
.container { max-width: 1000px; margin: 0 auto; padding: 0 32px 48px; }
.source-tiles { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 36px; }
.stile {
  background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
  padding: 18px 18px 14px; cursor: pointer; transition: all 0.12s ease;
  display: flex; flex-direction: column; gap: 4px; position: relative; overflow: hidden;
  text-decoration: none; color: inherit;
}
.stile::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: transparent; transition: background 0.12s ease; border-radius: 10px 0 0 10px;
}
.stile:hover { box-shadow: 0 2px 10px rgba(0,0,0,0.06); border-color: var(--text-light); }
.stile.yt:hover::before  { background: #E63946; }
.stile.pod:hover::before { background: #9B59B6; }
.stile.muted { cursor: default; opacity: 0.5; pointer-events: none; }
.stile-row1 { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.stile-icon { font-size: 16px; }
.stile-status {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  padding: 2px 7px; border-radius: 3px;
}
.stile-status.live { background: var(--text); color: var(--bg); }
.stile-status.empty { background: var(--hover); color: var(--text-light); }
.stile-status.soon { background: var(--hover); color: var(--text-light); }
.stile-name { font-size: 14px; font-weight: 600; letter-spacing: -0.1px; margin-bottom: 1px; }
.stile-sub { font-size: 12px; color: var(--text-light); margin-bottom: 10px; }
.stile-preview {
  font-size: 12px; color: var(--text-mid); line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; border-top: 1px solid var(--border); padding-top: 10px;
}
.stile-preview.italic { font-style: italic; color: var(--text-light); }
.stile-cta { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-light); margin-top: 6px; }
.section-label {
  font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 500;
  text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-light); margin-bottom: 12px;
}
.recent-item {
  display: flex; align-items: baseline; gap: 12px;
  padding: 13px 0; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: padding 0.1s ease; text-decoration: none; color: inherit;
}
.recent-item:hover { padding-left: 4px; }
.recent-item:last-child { border-bottom: none; }
.dot { width: 5px; height: 5px; border-radius: 50%; background: var(--border);
       flex-shrink: 0; margin-top: 7px; }
.recent-body { flex: 1; min-width: 0; }
.recent-title {
  font-size: 15px; font-weight: 500; letter-spacing: -0.1px; line-height: 1.35;
  margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.recent-meta { font-size: 12px; color: var(--text-light); }
.recent-tag {
  font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-light);
  background: var(--hover); padding: 2px 6px; border-radius: 3px;
  flex-shrink: 0; align-self: center;
}
.empty-state { text-align: center; color: var(--text-light); padding: 3rem; font-size: 14px; }
@media (max-width: 640px) {
  .header, .container { padding-left: 16px; padding-right: 16px; }
  .source-tiles { grid-template-columns: 1fr; }
  .header-app { font-size: 22px; }
}
</style>
</head>
<body>
<div class="header">
  <div class="header-date" id="headerDate"></div>
  <div class="header-app"><strong>Morning</strong> Brief</div>
</div>
<div class="container">
  <div class="source-tiles" id="tiles"></div>
  <div class="section-label" id="feedLabel"></div>
  <div id="feed"></div>
</div>
<script>
var ytIndex = [];
var podIndex = [];
var CATEGORIES = {};

async function init() {
  var today = new Date();
  var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('headerDate').textContent =
    days[today.getDay()] + '\u00b7 ' + months[today.getMonth()] + ' ' + today.getDate() + ' ' + today.getFullYear();

  try { var r = await fetch('categories.json'); CATEGORIES = r.ok ? await r.json() : {}; } catch(e) {}
  try { var r = await fetch('digest-index.json'); ytIndex = r.ok ? await r.json() : []; } catch(e) {}
  try { var r = await fetch('podcast-index.json'); podIndex = r.ok ? await r.json() : []; } catch(e) {}

  ytIndex = ytIndex.slice().sort().reverse();
  podIndex = podIndex.slice().sort().reverse();

  renderTiles();
  await renderFeed();
}

function renderTiles() {
  var latestYt = ytIndex[0] || null;
  var latestPod = podIndex[0] || null;

  var catNames = Object.keys(CATEGORIES).join(' \u00b7 ');

  var ytStatus = latestYt
    ? '<span class="stile-status live" id="ytCount">...</span>'
    : '<span class="stile-status empty">no data</span>';
  var podStatus = latestPod
    ? '<span class="stile-status live" id="podCount">...</span>'
    : '<span class="stile-status empty">no data</span>';

  // Placeholders — renderFeed will update href, count and preview once it resolves the real date
  var ytPreview = latestYt ? '<div class="stile-preview" id="ytPreview">loading...</div>' : '<div class="stile-preview italic">No YouTube digests yet</div>';
  var podPreview = latestPod ? '<div class="stile-preview" id="podPreview">loading...</div>' : '<div class="stile-preview italic">No podcast digests yet</div>';

  var ytCta = latestYt ? '<div class="stile-cta">View all &rarr;</div>' : '';
  var podCta = latestPod ? '<div class="stile-cta">View all &rarr;</div>' : '';

  var ytClass = latestYt ? 'stile yt' : 'stile yt muted';
  var podClass = latestPod ? 'stile pod' : 'stile pod muted';

  // Tiles start with placeholder hrefs; renderFeed() will update them once dates are resolved
  document.getElementById('tiles').innerHTML =
    '<a class="' + ytClass + '" href="youtube.html" id="ytTile">' +
      '<div class="stile-row1"><span class="stile-icon">&#9654;</span>' + ytStatus + '</div>' +
      '<div class="stile-name">YouTube</div>' +
      '<div class="stile-sub">' + (catNames || 'No categories') + '</div>' +
      ytPreview + ytCta +
    '</a>' +
    '<a class="' + podClass + '" href="podcasts.html" id="podTile">' +
      '<div class="stile-row1"><span class="stile-icon">&#127897;</span>' + podStatus + '</div>' +
      '<div class="stile-name">Podcasts</div>' +
      '<div class="stile-sub">' + (catNames || 'No categories') + '</div>' +
      podPreview + podCta +
    '</a>';
}

async function renderFeed() {
  var latestYt = ytIndex[0] || null;
  var latestPod = podIndex[0] || null;

  if (!latestYt && !latestPod) {
    document.getElementById('feedLabel').textContent = '';
    document.getElementById('feed').innerHTML = '<div class="empty-state">No content yet. Run the pipeline first.</div>';
    return;
  }

  var items = [];
  var ytDateUsed = null;
  var podDateUsed = null;

  if (latestYt) {
    try {
      // Walk dates newest-first until we find one with actual content
      var ytDates = ytIndex.slice(0, 3).filter(Boolean);
      for (var yi = 0; yi < ytDates.length; yi++) {
        var resp = await fetch('daily/' + ytDates[yi] + '.md');
        if (resp.ok) {
          var md = await resp.text();
          var parsed = parseDigest(md, 'youtube', ytDates[yi]);
          if (parsed.length > 0) {
            items = items.concat(parsed);
            ytDateUsed = ytDates[yi];
            var el = document.getElementById('ytCount');
            var el2 = document.getElementById('ytPreview');
            var tile = document.getElementById('ytTile');
            if (el) el.textContent = parsed.length + ' new';
            if (el2) el2.textContent = parsed[0].title;
            if (tile) tile.href = 'youtube.html?date=' + encodeURIComponent(ytDateUsed);
            break;
          }
        }
      }
      // Only show "Nothing new" if truly no date had content
      if (!ytDateUsed) {
        var el = document.getElementById('ytCount');
        var el2 = document.getElementById('ytPreview');
        if (el) el.textContent = '0 new';
        if (el2) el2.textContent = 'Nothing new today';
      }
    } catch(e) {}
  }

  if (latestPod) {
    try {
      // Walk dates newest-first until we find one with actual content
      var podDates = podIndex.slice(0, 3).filter(Boolean);
      for (var pi = 0; pi < podDates.length; pi++) {
        var resp = await fetch('podcast-daily/' + podDates[pi] + '.md');
        if (resp.ok) {
          var md = await resp.text();
          var parsed = parseDigest(md, 'podcast', podDates[pi]);
          if (parsed.length > 0) {
            items = items.concat(parsed);
            podDateUsed = podDates[pi];
            var el = document.getElementById('podCount');
            var el2 = document.getElementById('podPreview');
            var tile = document.getElementById('podTile');
            if (el) el.textContent = parsed.length + ' new';
            if (el2) el2.textContent = parsed[0].title;
            if (tile) tile.href = 'podcasts.html?date=' + encodeURIComponent(podDateUsed);
            break;
          }
        }
      }
      // Only show "Nothing new" if truly no date had content
      if (!podDateUsed) {
        var el = document.getElementById('podCount');
        var el2 = document.getElementById('podPreview');
        if (el) el.textContent = '0 new';
        if (el2) el2.textContent = 'Nothing new today';
      }
    } catch(e) {}
  }

  if (items.length === 0) {
    document.getElementById('feedLabel').textContent = '';
    document.getElementById('feed').innerHTML = '<div class="empty-state">No content found for today.</div>';
    return;
  }

  var feedDateStr = ytDateUsed || podDateUsed || latestYt || latestPod;
  var fd = new Date(feedDateStr + 'T00:00:00');
  var months2 = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('feedLabel').textContent =
    'All sources \u00b7 ' + months2[fd.getMonth()] + ' ' + fd.getDate();

  var html = '';
  for (var i = 0; i < items.length; i++) {
    var item = items[i];
    var baseHref = item.type === 'youtube' ? 'youtube.html' : 'podcasts.html';
    var href = baseHref + '?date=' + encodeURIComponent(item.date);
    if (item.category) href += '&category=' + encodeURIComponent(item.category);
    html += '<a class="recent-item" href="' + href + '">' +
      '<div class="dot"></div>' +
      '<div class="recent-body">' +
        '<div class="recent-title">' + escHtml(item.title) + '</div>' +
        '<div class="recent-meta">' + escHtml(item.meta) + '</div>' +
      '</div>' +
      '<div class="recent-tag">' + item.type + '</div>' +
      '</a>';
  }
  document.getElementById('feed').innerHTML = html;
}

function parseDigest(md, type, dateStr) {
  var items = [];
  var lines = md.split('\n');
  var currentCat = '';
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    if (line.startsWith('## ')) { currentCat = line.substring(3).trim(); continue; }
    if (!line.startsWith('### ')) continue;
    var title = line.substring(4).trim();
    // Next non-empty line has: **Source** | duration | date | [Watch/Listen](url)
    var meta = '';
    for (var j = i + 1; j < lines.length && j < i + 5; j++) {
      if (lines[j].trim()) {
        meta = lines[j].replace(/\*\*/g, '').replace(/\[.*?\]\(.*?\)/g, '').replace(/\|/g, '·').trim();
        meta = meta.replace(/\s{2,}/g, ' ').replace(/^·\s*|\s*·$/g, '').trim();
        break;
      }
    }
    if (title && title !== 'No new content found today.' && !title.startsWith('No new')) {
      items.push({ title: title, meta: meta, type: type, category: currentCat, date: dateStr });
    }
  }
  return items;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

init();
</script>
</body>
</html>