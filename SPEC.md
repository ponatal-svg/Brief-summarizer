# Morning Brief Summarizer — Project Spec

> This is the spec that *should have existed before coding started*.
> It is written retrospectively, capturing every decision that caused bugs or confusion.

---

## 1. Purpose

A daily pipeline that fetches the latest YouTube videos and podcast episodes from a curated list of sources, summarises them with Gemini AI, and publishes the results as a static website on GitHub Pages. It runs automatically every morning via GitHub Actions.

---

## 2. User Contract

| Question | Answer |
|---|---|
| Who reads the output? | One user, via a browser at the GitHub Pages URL |
| How fresh must the content be? | Today's content live by 7 AM local time (PST) |
| How many days of history? | Exactly 7 days, inclusive of today |
| What happens if a source fails? | Skip it, log it, still deploy everything else |
| What languages are supported? | English, Spanish, Hebrew (display only — no RTL layout changes needed) |

---

## 3. Retention Policy — Exact Boundary Definition

**"Keep 7 days"** means: on any given run date D, content dated `[D-6 … D]` is kept. Content dated `D-7` or older is **removed**.

| Run date | Cutoff (removed if ≤ this) | Kept range |
|---|---|---|
| 2026-02-26 | 2026-02-19 | Feb 20 – Feb 26 |
| 2026-02-27 | 2026-02-20 | Feb 21 – Feb 27 |

**Implementation rule:** `cutoff = today - timedelta(days=7)`. Remove if `date <= cutoff`. Keep if `date > cutoff`.

**Test requirement:** There must be a test with a file dated exactly `today - 7` asserting it is **removed**, and one dated `today - 6` asserting it is **kept**.

---

## 4. Pipeline Schedule

- **Cron:** `0 14 * * *` (14:00 UTC)
- **Why 14:00 UTC:** 6 AM PST / 9 AM EST. Same calendar date in all US timezones. Low YouTube traffic window.
- **Consequence:** Files processed by the pipeline are always stamped with the same date in PST, MST, CST, and EST.

---

## 5. File Layout

```
output/
  index.html                  ← Hub page (static, never overwritten by pipeline)
  youtube.html                ← YouTube viewer (generated by viewer.py)
  podcasts.html               ← Podcast viewer (generated by viewer.py)
  digest-index.json           ← Sorted list of YouTube digest dates ["YYYY-MM-DD", ...]
  digest-counts.json          ← {YYYY-MM-DD: N} YouTube summary count per date
  podcast-index.json          ← Sorted list of podcast digest dates
  podcast-counts.json         ← {YYYY-MM-DD: N} podcast episode count per date
  categories.json             ← [{name, color}, ...] from config
  daily/
    YYYY-MM-DD.md             ← YouTube daily digest
  podcast-daily/
    YYYY-MM-DD.md             ← Podcast daily digest
  summaries/
    YYYY-MM-DD/
      <slug>.md               ← One file per YouTube video summary
  podcast-summaries/
    YYYY-MM-DD/
      <slug>.md               ← One file per podcast episode summary
  errors/
    YYYY-MM-DD-errors.md      ← Error report (optional, only on failures)
```

**Rule:** Every viewer page (YouTube and podcast) has a **matching pair** of JSON support files. Adding a new viewer page requires adding its index JSON *and* its counts JSON. Checklist:

- [ ] `*-index.json` generated in `generate_viewer()`
- [ ] `*-counts.json` generated in `generate_viewer()`
- [ ] `fetch('*-index.json')` replaced in the HTML template
- [ ] `fetch('*-counts.json')` replaced in the HTML template
- [ ] `fetch('*-daily/')` replaced in the HTML template
- [ ] `fetch('*-summaries/')` replaced in the HTML template

---

## 6. State File

```json
{
  "youtube":   { "<video_id>":   {"date": "YYYY-MM-DD", "channel": "...", "title": "..."} },
  "podcasts":  { "<episode_id>": "YYYY-MM-DD" },
  "rss_cache": { "<podcast_url>": "<rss_feed_url>" },
  "ip_blocked": ["<video_id>", ...]
}
```

**Rules:**
- `youtube` values may be a plain `"YYYY-MM-DD"` string (legacy) or a dict. Code must handle both with `isinstance(date_val, dict)`.
- `rss_cache` is never expired — it persists indefinitely.
- `ip_blocked` entries are retried on the next run; they are not errors.

---

## 7. GitHub Actions Workflows

### `morning-brief.yaml`
```
jobs:
  summarize → deploy
```
- `deploy` must have `if: always()` — Pages must update even when `summarize` partially fails (e.g. one source IP-blocked). Without this, a single source failure leaves the site stale.

### `deploy-pages.yaml`
- Manual trigger only (`workflow_dispatch`)
- Deploys whatever is currently in `output/` on `main`, without re-running the pipeline
- Use case: pushing fixes to viewer/config mid-day without waiting for the nightly run

---

## 8. Error Classification

| Situation | Classification | `sys.exit` |
|---|---|---|
| Gemini API key invalid (401/403) | **Error** — stop immediately | `exit(1)` |
| Gemini quota exhausted | **Error** — stop, save progress | `exit(1)` |
| YouTube IP block | **Operational skip** — retry next run | no exit |
| No transcript available | **Operational skip** | no exit |
| RSS feed not found | **Error** for that show, skip it | no exit |
| Network timeout on one source | **Operational skip** | no exit |

**Rule:** `sys.exit(1)` fires only when `len(errors) > 0`. A run with only `skipped_items` exits 0.

---

## 9. Podcast RSS Resolution

Resolution order for any `podcast_url`:

1. Check `rss_cache` in state — use cached URL if present
2. iTunes Search API (keyless) — covers ~90% of shows
3. If `podcast_url` looks like an RSS URL (contains `/rss`, `/feed`, `.xml`) — use directly
4. Validate `podcast_url` as RSS directly
5. Raise `RSSLookupError` with actionable message pointing to podcastindex.org

**Note:** Spotify URLs (`open.spotify.com/show/...`) are **not** RSS feeds. They must go through step 2. Never attempt to fetch Spotify URLs as RSS.

---

## 10. Cleanup — What Gets Cleaned

On every run, after content is generated:

| Cleaned | Condition |
|---|---|
| `output/summaries/YYYY-MM-DD/` | `date <= today - 7` |
| `output/podcast-summaries/YYYY-MM-DD/` | `date <= today - 7` |
| `output/daily/YYYY-MM-DD.md` | `date <= today - 7` |
| `output/podcast-daily/YYYY-MM-DD.md` | `date <= today - 7` |
| `output/errors/YYYY-MM-DD-errors.md` | `date <= today - 7` |
| `state.json` youtube/podcasts entries | `date <= today - 7` |
| `state.json` rss_cache | **Never** cleaned |
| `output/index.html` | **Never** overwritten |

---

## 11. Code Quality Rules

- All imports at **module top level** — never inside functions, loops, or conditionals
- No `except Exception: pass` — at minimum `logger.debug(...)`
- No duplicate constants — `LANGUAGE_NAMES` lives in `summarizer.py`; all other modules import from there
- Magic numbers must be named constants (e.g. `_TRANSCRIPT_API_PACE_SECONDS = 5`)
- Test coverage: **≥ 90% per file**, enforced with `pytest-cov`
- All external I/O mocked in unit tests; integration tests behind `--integration` flag

---

## 12. Definition of Done

A change is **done** only when all of the following are true:

- [ ] `python3 -m pytest` passes with ≥ 90% coverage per file
- [ ] `python3 -m src.main --dry-run` output reviewed and matches expectation
- [ ] Changes pushed to `main` and Pages deployment confirmed via `curl` on the live URL
- [ ] The specific date mentioned in the change is visible in the browser with correct content

---

## 13. Config Schema

```yaml
categories:
  - name: string        # used in viewer UI and for routing content
    color: "#RRGGBB"

sources:
  youtube:
    - channel_url: string
      name: string
      category: string  # must match a category name exactly
      language: string  # optional, default "en"

  podcasts:
    - podcast_url: string   # Spotify URL or direct RSS URL
      name: string
      category: string
      language: string      # optional, default "en"

settings:
  max_age_days: int           # retention window
  gemini_model: string
  max_videos_per_channel: int
  lookback_hours: int         # fetch window; fallback to latest if nothing found
  max_episodes_per_show: int
  min_episodes_per_show: int  # guarantee at least this many even outside window
  max_audio_minutes: int      # cap audio download length
  notify_email: string|null
```

**Validation rules enforced at load time:**
- `category` must exist in the `categories` list
- `podcast_url` is required (field was formerly `spotify_url` — that name is rejected)
- `settings` block is required

---

## 14. Acceptance Tests (manual, run before declaring any release done)

```
# 1. Dry run shows expected sources
python3 -m src.main --dry-run

# 2. Live URLs return 200
curl -I https://ponatal-svg.github.io/Brief-summarizer/podcast-counts.json
curl -I https://ponatal-svg.github.io/Brief-summarizer/digest-counts.json
curl -I https://ponatal-svg.github.io/Brief-summarizer/podcast-index.json

# 3. Viewer shows correct date range (exactly 7 dates)
curl -s https://ponatal-svg.github.io/Brief-summarizer/podcast-index.json | python3 -c "
import json,sys,datetime
dates = json.load(sys.stdin)
print(f'{len(dates)} dates: {dates[0]} → {dates[-1]}')
assert len(dates) <= 7, f'Expected ≤7 dates, got {len(dates)}'
"

# 4. Counts match actual files
curl -s https://ponatal-svg.github.io/Brief-summarizer/podcast-counts.json
```
